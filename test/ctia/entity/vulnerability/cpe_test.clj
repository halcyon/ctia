(ns ctia.entity.vulnerability.cpe-test
  (:require
   [clojure.test :refer :all]
   [ctia.entity.vulnerability.cpe :as sut]))

(def single-configuration-no-children
  {:configurations {:nodes [{:operator "OR",
                             :cpe_match [{:cpe23Uri "cpe:2.3:o:microsoft:windows_10:-:*:*:*:*:*:*:*"}
                                         {:cpe23Uri "cpe:2.3:o:microsoft:windows_10:20h2:*:*:*:*:*:*:*"}
                                         {:cpe23Uri "cpe:2.3:o:microsoft:windows_10:1607:*:*:*:*:*:*:*"}]}]}
   :id "vulnerability-one"})

(def single-configuration-with-children
  {:configurations {:nodes [{:operator "AND"
                             :children [{:operator "OR"
                                         :cpe_match [{:cpe23Uri "cpe:2.3:a:nvidia:virtual_gpu_manager:*:*:*:*:*:*:*:*"}
                                                     {:cpe23Uri "cpe:2.3:a:nvidia:virtual_gpu_manager:*:*:*:*:*:*:*:*"}]}
                                        {:operator "OR"
                                         :cpe_match [{:cpe23Uri "cpe:2.3:o:citrix:hypervisor:-:*:*:*:*:*:*:*"}
                                                     {:cpe23Uri "cpe:2.3:o:nutanix:ahv:-:*:*:*:*:*:*:*"}
                                                     {:cpe23Uri "cpe:2.3:o:redhat:enterprise_linux_kernel-based_virtual_machine:-:*:*:*:*:*:*:*"}
                                                     {:cpe23Uri "cpe:2.3:o:vmware:vsphere:-:*:*:*:*:*:*:*"}]}]}]}
   :id "vulnerability-two"})

(def multiple-configurations
  {:configurations {:nodes [{:operator "AND"
                             :children
                             [{:operator "OR"
                               :cpe_match [{:cpe23Uri "cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"}
                                           {:cpe23Uri "cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"}
                                           {:cpe23Uri "cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"}
                                           {:cpe23Uri "cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"}]}
                              {:operator "OR"
                               :cpe_match [{:cpe23Uri "cpe:2.3:o:microsoft:windows:-:*:*:*:*:*:*:*"}]}]}
                            {:operator "AND"
                             :children [{:operator "OR"
                                         :cpe_match [{:cpe23Uri "cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"}
                                                     {:cpe23Uri "cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"}
                                                     {:cpe23Uri "cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"}]}
                                        {:operator "OR"
                                         :cpe_match [{:cpe23Uri "cpe:2.3:o:linux:linux_kernel:-:*:*:*:*:*:*:*"}]}]}]}
   :id "vulnerability-three"})

(deftest test-apply-operator
  (testing "should return truthy"
    (are [operator operands]
        (sut/apply-operator {:negate false
                             :operands operands
                             :operator operator
                             :result true})
      "OR" [false false true]
      "OR" [false true false]
      "OR" [["ted"] nil "fred"]
      "AND" [true true true]
      "AND" [true true true 18]
      "AND" [["ted"] true "fred" true]))

  (testing "should return truthy"
    (are [operator operands]
        (sut/apply-operator {:negate true
                             :operands operands
                             :operator operator
                             :result true})

      "OR" [false false false]
      "OR" [false false false]
      "AND" [false false false]
      "AND" [false false false]))

  (testing "should return falsey"
    (are [operator operands]
        (not (sut/apply-operator {:negate true
                                  :operands operands
                                  :operator operator
                                  :result true}))
      "OR" [false false true]
      "OR" [false true false]
      "OR" [["ted"] nil "fred"]
      "AND" [true true true]
      "AND" [true true true 18]
      "AND" [["ted"] true "fred" true]))

  (testing "should return falsey"
    (are [operator operands]
        (not (sut/apply-operator {:operands operands
                                  :operator operator
                                  :result true}))
      "OR" [false false false]
      "OR" [false false false]
      "AND" [false false false]
      "AND" [false false false])))

(deftest test-cpe-match
  (let [or-cpe-match {:operator "OR",
                      :cpe_match [{:cpe23Uri "cpe:2.3:o:microsoft:windows_10:-:*:*:*:*:*:*:*"}
                                  {:cpe23Uri "cpe:2.3:o:microsoft:windows_10:20h2:*:*:*:*:*:*:*"}
                                  {:cpe23Uri "cpe:2.3:o:microsoft:windows_10:1607:*:*:*:*:*:*:*"}
                                  {:cpe23Uri "cpe:2.3:o:microsoft:windows_10:1803:*:*:*:*:*:*:*"}]}
        and-cpe-match {:operator "AND"
                       :cpe_match [{:cpe23Uri "cpe:2.3:a:nvidia:virtual_gpu_manager:*:*:*:*:*:*:*:*"}
                                   {:cpe23Uri "cpe:2.3:o:redhat:enterprise_linux_kernel-based_virtual_machine:-:*:*:*:*:*:*:*"}]}]
    (testing "OR CPEs should match"
      (are [cpes] (sut/query-cpe-matches or-cpe-match cpes)
        ["cpe:2.3:o:microsoft:windows_10:-:*:*:*:*:*:*:*"]
        ["cpe:2.3:o:microsoft:windows_10:20h2:*:*:*:*:*:*:*"]
        ["cpe:2.3:o:microsoft:windows_10:1607:*:*:*:*:*:*:*"]
        ["cpe:2.3:o:microsoft:windows_10:1803:*:*:*:*:*:*:*"]

        ["cpe:2.3:o:microsoft:windows_10:-:*:*:*:*:*:*:*"
         "cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"
         "cpe:2.3:a:nvidia:virtual_gpu_manager:*:*:*:*:*:*:*:*"]))
    (testing "OR CPEs should not match"
      (are [cpes] (not (sut/query-cpe-matches or-cpe-match cpes))
        ["cpe:2.3:o:microsoft:fake-windows:-:*:*:*:*:*:*:*"]
        ["cpe:2.3:o:microsoft:fake-windows:-:*:*:*:*:*:*:*"
         "cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"
         "cpe:2.3:a:nvidia:virtual_gpu_manager:*:*:*:*:*:*:*:*"]))
    (testing "AND CPEs should match"
      (are [cpes] (sut/query-cpe-matches and-cpe-match cpes)
        ["cpe:2.3:a:nvidia:virtual_gpu_manager:*:*:*:*:*:*:*:*"
         "cpe:2.3:o:redhat:enterprise_linux_kernel-based_virtual_machine:-:*:*:*:*:*:*:*"]))
    (testing "AND CPEs should not match"
      (are [cpes] (not (sut/query-cpe-matches and-cpe-match cpes))
        ["cpe:2.3:o:microsoft:fake-windows:-:*:*:*:*:*:*:*"
         "cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"
         "cpe:2.3:a:nvidia:virtual_gpu_manager:*:*:*:*:*:*:*:*"]))))

(deftest test-vulnerability->ids
  (is (= ["CVE-2021-0301"]
         (sut/vulnerabilities->ids ["cpe:2.3:o:google:android:-:*:*:*:*:*:*:*"]
                                   [{:id "CVE-2021-0301"
                                     :configurations {:nodes [{:operator "OR",
                                                               :cpe_match
                                                               [{:vulnerable true,
                                                                 :cpe23Uri "cpe:2.3:o:google:android:-:*:*:*:*:*:*:*"}]}]}}])))
  (testing "CPEs should match these CVEs"
    (are [cve cpes]
        (= [(:id cve)] (sut/vulnerabilities->ids cpes [cve]))
      single-configuration-no-children ["cpe:2.3:o:microsoft:windows_10:1607:*:*:*:*:*:*:*"]
      single-configuration-with-children ["cpe:2.3:a:nvidia:virtual_gpu_manager:*:*:*:*:*:*:*:*"
                                          "cpe:2.3:o:redhat:enterprise_linux_kernel-based_virtual_machine:-:*:*:*:*:*:*:*"]
      multiple-configurations ["cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"
                               "cpe:2.3:o:microsoft:windows:-:*:*:*:*:*:*:*"]
      multiple-configurations ["cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"
                               "cpe:2.3:o:linux:linux_kernel:-:*:*:*:*:*:*:*"]))
  (testing "CPEs should not match these CVEs"
    (are [cve cpes]
        (empty? (sut/vulnerabilities->ids cpes [cve]))
      single-configuration-no-children ["cpe:2.3:o:fred:windows_server_2019:-:*:*:*:*:*:*:*"]
      single-configuration-with-children ["cpe:2.3:o:redhat:enterprise_linux_kernel-based_virtual_machine:-:*:*:*:*:*:*:*"]
      multiple-configurations ["cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"
                               "cpe:2.3:o:redhat:enterprise_linux_kernel-based_virtual_machine:-:*:*:*:*:*:*:*"
                               "cpe:2.3:o:android:android_kernel:-:*:*:*:*:*:*:*"]
      multiple-configurations ["cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"
                               "cpe:2.3:o:openbsd:openbsd_kernel:-:*:*:*:*:*:*:*"]))
  (testing "Should match vulnerability-one and vulnerability-three"
    (is (= ["vulnerability-one"
            "vulnerability-three"]
           (sut/vulnerabilities->ids ["cpe:2.3:a:nvidia:gpu_driver:*:*:*:*:*:*:*:*"
                                      "cpe:2.3:o:linux:linux_kernel:-:*:*:*:*:*:*:*"
                                      "cpe:2.3:o:microsoft:windows_10:-:*:*:*:*:*:*:*"]
                                     [single-configuration-no-children
                                      single-configuration-with-children
                                      multiple-configurations])))))
